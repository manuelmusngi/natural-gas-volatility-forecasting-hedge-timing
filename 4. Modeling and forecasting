#### 4. Modeling and forecasting

Compare:

- A non‑linear RandomForestRegressor on the full feature set
- (Optional) A linear HAR‑style regression for interpretability

Use time‑series cross‑validation and evaluate RMSE on the future RV target.

# RF model
target_col = "target_rv_fwd"
feature_cols = [c for c in features.columns if c not in ["spot", target_col]]

X = features[feature_cols]
y = features[target_col]

tscv = TimeSeriesSplit(n_splits=5)

rf = RandomForestRegressor(
    n_estimators=model_cfg.get("rf_n_estimators", 300),
    max_depth=model_cfg.get("rf_max_depth", 6),
    random_state=42,
    n_jobs=-1,
)

rf_rmse_scores = []
oos_preds = pd.Series(index=y.index, dtype=float)

for train_idx, test_idx in tscv.split(X):
    X_train, X_test = X.iloc[train_idx], X.iloc[test_idx]
    y_train, y_test = y.iloc[train_idx], y.iloc[test_idx]

    rf.fit(X_train, y_train)
    y_pred = rf.predict(X_test)
    oos_preds.iloc[test_idx] = y_pred

    rmse = mean_squared_error(y_test, y_pred, squared=False)
    rf_rmse_scores.append(rmse)

print("RF RMSE by split:", rf_rmse_scores)
print("RF mean RMSE:", np.mean(rf_rmse_scores))

